# NotRandomPeople - AI Telegram Bot

Telegram-бот — электронный экскурсовод по Казани и Республике Татарстан с поддержкой нескольких AI провайдеров, аудио-экскурсиями и построением туристических маршрутов.

## Основные возможности

### Электронный экскурсовод
- **Аудио-экскурсии по геолокации** — отправьте свое местоположение и получите текстовое описание достопримечательности с голосовым сопровождением
- **База объектов культурного наследия** — более 100 достопримечательностей Казани и Татарстана с историей, интересными фактами и координатами
- **Построение маршрутов** — оптимальные туристические маршруты с учетом вашего местоположения
- **Интеграция с Яндекс.Картами** — готовые ссылки для навигации по маршруту

### AI-ассистент
- **3 AI провайдера на выбор**: YandexGPT (по умолчанию), OpenAI (GPT-4), DeepSeek
- **Сохранение контекста диалога** — до 10 сообщений истории для связных разговоров
- **Переключение между провайдерами** на лету через команды

### Мультиязычность
- **Русский язык** — полная поддержка
- **Татарский язык** — интерфейс и AI-ответы

### Дополнительно
- Фильтрация нежелательного контента
- Асинхронная обработка с индикацией набора текста
- Логирование в Grafana Loki + консоль
- Unit-тесты

## Технологический стек

| Технология | Назначение | Версия |
|-----------|---------|--------|
| .NET | Платформа | 8.0 |
| Telegram.Bot | Telegram API | 19.0.0 |
| YandexGPT | Генерация текста экскурсий | Latest |
| Yandex Geocoding | Определение адреса по координатам | API v1.x |
| ElevenLabs | Синтез речи (Text-to-Speech) | v1 |
| DeepSeek | Альтернативный AI провайдер | Latest |
| OpenAI | Альтернативный AI провайдер | Latest |
| Serilog | Структурированное логирование | 3.1.1 |

## Архитектура

Проект построен на чистой архитектуре с разделением на слои:

```
AiTelegramBot/
├── Handlers/              # Обработчики команд и сообщений
│   ├── CommandHandler.cs  # Обработка команд (/start, /tour, /route, etc.)
│   └── MessageHandler.cs  # Обработка текста и геолокации
├── Services/              # Бизнес-логика
│   ├── AI Services/       # YandexGPT, OpenAI, DeepSeek + Factory
│   ├── Tour Services/     # TourGuideService, RouteService
│   ├── Location Services/ # Geocoding, HeritageService
│   └── Other Services/    # Localization, ContentFilter, ElevenLabs
├── Models/                # Модели данных и конфигурации
├── Data/                  # JSON база объектов наследия
├── Logging/               # Интеграция с Grafana Loki
└── Program.cs             # Точка входа и DI

AiTelegramBot.Tests/       # Unit-тесты
```

## Как это работает

### Режим экскурсовода

```
Пользователь → /tour → Отправляет геолокацию
                            ↓
                    Yandex Geocoding API
                    (координаты → адрес)
                            ↓
                    YandexGPT генерирует
                    текст экскурсии (200-300 слов)
                            ↓
                    ElevenLabs синтезирует
                    голосовое сообщение
                            ↓
                    Бот отправляет текст + аудио
```

### Построение маршрута

```
Пользователь → /route → Отправляет геолокацию
                              ↓
                      Определение района
                              ↓
                      Поиск ближайших
                      достопримечательностей
                              ↓
                      Оптимизация маршрута
                      (алгоритм ближайшего соседа)
                              ↓
                      Генерация описания
                      + ссылка на Яндекс.Карты
```

### Режим чат-бота

```
Пользователь → Текстовое сообщение
                      ↓
              ContentFilterService
              (проверка контента)
                      ↓
              ConversationService
              (получение контекста)
                      ↓
              AiServiceFactory
              (выбор провайдера)
                      ↓
              AI Service (DeepSeek/OpenAI/YandexGPT)
              + история диалога
                      ↓
              Ответ пользователю
```

## Команды бота

### Основные
| Команда | Описание |
|---------|----------|
| `/start` | Начать диалог, приветствие с описанием возможностей |
| `/help` | Список всех команд |
| `/about` | Информация о боте и технологиях |
| `/reset` | Сбросить контекст диалога |

### Экскурсии и маршруты
| Команда | Описание |
|---------|----------|
| `/tour` | Получить аудио-экскурсию по текущему местоположению |
| `/route` | Построить маршрут от текущего местоположения |
| `/route_between` | Построить маршрут между двумя точками |

### Настройки
| Команда | Описание |
|---------|----------|
| `/language` | Выбрать язык интерфейса (ru/tt) |
| `/lang_ru` | Переключить на русский |
| `/lang_tt` | Переключить на татарский |
| `/provider` | Выбрать AI провайдер |
| `/provider_yandex` | Использовать YandexGPT |
| `/provider_openai` | Использовать OpenAI |
| `/provider_deepseek` | Использовать DeepSeek |

## База объектов культурного наследия

Бот содержит базу данных с более чем **100 объектами** культурного наследия Казани и Татарстана:

### Категории объектов
- Архитектурные ансамбли
- Религиозные сооружения
- Исторические здания
- Памятники и монументы
- Объекты ЮНЕСКО

### Данные по каждому объекту
- Название и координаты
- Адрес и район
- Категория и уровень охраны (федеральный/региональный/местный)
- Краткое описание и история
- Интересные факты
- Год постройки
- Регистрационный номер

### Примеры объектов
- Казанский Кремль (объект ЮНЕСКО)
- Мечеть Кул-Шариф
- Башня Сююмбике
- Благовещенский собор
- Улица Баумана
- Храм всех религий
- и многое другое...

## Требования

- .NET 8.0 SDK
- Telegram Bot Token (через [@BotFather](https://t.me/BotFather))
- API ключи (минимум один из):
  - YandexGPT + Yandex Geocoding
  - OpenAI
  - DeepSeek
- ElevenLabs API ключ (для аудио-экскурсий)

## Установка и настройка

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd NotRandomPeople
```

### 2. Настройка конфигурации

Создайте файл `AiTelegramBot/appsettings.json`:

```json
{
  "Telegram": {
    "BotToken": "ваш_токен_бота",
    "AllowedUsers": []
  },
  "AiProvider": {
    "Provider": "YandexGpt"
  },
  "YandexGpt": {
    "OAuthToken": "ваш_oauth_токен",
    "FolderId": "ваш_folder_id",
    "Model": "yandexgpt/latest",
    "Temperature": 0.6,
    "MaxTokens": 1000
  },
  "YandexGeocoding": {
    "ApiKey": "ваш_api_ключ",
    "ApiUrl": "https://geocode-maps.yandex.ru/1.x/"
  },
  "ElevenLabs": {
    "ApiKey": "ваш_api_ключ",
    "VoiceId": "3EuKHIEZbSzrHGNmdYsx",
    "ModelId": "eleven_multilingual_v2"
  },
  "DeepSeek": {
    "ApiKey": "ваш_ключ",
    "Model": "deepseek-chat",
    "Temperature": 0.7,
    "MaxTokens": 2000,
    "ApiUrl": "https://api.deepseek.com/v1/chat/completions"
  },
  "OpenAI": {
    "ApiKey": "ваш_ключ",
    "Model": "gpt-4o-mini",
    "Temperature": 0.7,
    "MaxTokens": 2000
  },
  "Conversation": {
    "MaxHistoryMessages": 10,
    "SystemPrompt": "Ты — дружелюбный экскурсовод по Казани..."
  },
  "ContentFilter": {
    "EnableFiltering": true,
    "BlockedWords": ["спам", "реклама"],
    "WarnOnDetection": true
  },
  "Logging": {
    "ServiceName": "notRandomPeopleBot",
    "DeploymentEnvironment": "production",
    "LokiEndpoint": "https://logs-prod-039.grafana.net/loki/api/v1/push",
    "GrafanaCloudAccessToken": "ваш_токен"
  }
}
```

### 3. Запуск

```bash
cd AiTelegramBot
dotnet restore
dotnet build
dotnet run
```

### 4. Запуск тестов

```bash
cd AiTelegramBot.Tests
dotnet test
```

## Docker

### Сборка образа

```bash
docker build -t notrandompeoplebot .
```

### Запуск контейнера

```bash
docker run -d --name bot notrandompeoplebot
```

## Логирование

### Консоль
Все логи с уровнем Information и выше автоматически выводятся в консоль.

### Grafana Loki (опционально)
Структурированные логи с метками (service, environment) отправляются в Grafana Cloud.

### Что логируется
- Входящие сообщения пользователей
- Запросы к AI API
- Запросы к Geocoding API
- Генерация аудио
- Ошибки при обработке
- Смена языка/провайдера

## Особенности реализации

### Управление контекстом
- In-memory хранение контекста по userId
- Автоматическая очистка старых контекстов (>24 часов) каждые 30 минут
- Потокобезопасный доступ через ConcurrentDictionary

### IAM токены YandexGPT
- Автоматическое обновление токена каждые 2 часа
- SemaphoreSlim для предотвращения race conditions
- Кэширование токена в памяти

### Оптимизация маршрутов
- Алгоритм ближайшего соседа
- Формула Хаверсина для расчета расстояний
- Ограничение маршрута до 7 точек

### Graceful degradation
- При ошибке синтеза речи — отправляется только текст
- При недоступности AI — информативное сообщение об ошибке

## Дополнительная документация

- [QUICK_START.md](QUICK_START.md) — быстрый старт
- [TOUR_GUIDE_SETUP.md](TOUR_GUIDE_SETUP.md) — настройка функции экскурсовода
- [CHANGELOG.md](CHANGELOG.md) — история изменений

## Лицензия

MIT

## Авторы

NotRandomPeople Team
